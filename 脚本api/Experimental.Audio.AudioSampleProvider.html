<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <link href="./css/stylesheet.css" rel="stylesheet" type="text/css"><title>Unity - Scripting API: AudioSampleProvider</title></head> <body> <div class="content"><div class="section"><div class="mb20 clear" id=""><div class="message message-error mb20"><b>Experimental</b>: this API is experimental and might be changed or removed in the future.</div><h1 class="heading inherit">AudioSampleProvider</h1><div class="clear"></div><p class="cl mb0 left mr10">class in
          UnityEngine.Experimental.Audio</p><p class="cl mb0 left mr10">/</p><p class="cl mb0 left">Implemented in:<a href="UnityEngine.AudioModule.html" class="cl">UnityEngine.AudioModule</a></p><div class="clear"></div><div class="suggest"><div class="suggest-wrap rel hide"><div class="loading hide"><div></div><div></div><div></div></div></div></div><a href="" class="switch-link gray-btn sbtn left hide"></a><div class="clear"></div></div><div class="subsection"><div class="signature"><div class="signature-CS sig-block"><span style="color:red;"></span></div></div></div><div class="subsection"><h2>Description   描述</h2><p>Provides access to the audio samples generated by Unity objects such as VideoPlayer.</p></div><div class="subsection"><p>This class is meant to be usable outside the main thread and the implementation assumes a single consumer at a time invoking <a href="Experimental.Audio.AudioSampleProvider.ConsumeSampleFrames.html">AudioSampleProvider.ConsumeSampleFrames</a>. Audio data can be accessed both from C# and from C++, depending on what has to be done with this data.<br /><br />The following is an example of how to access samples from C# using an accessor obtained from the <a href="Video.VideoPlayer.html">VideoPlayer</a>:</p></div><div class="subsection">
        
        <pre class="codeExampleCS">
using UnityEngine;
using Unity.Collections;
using UnityEngine.Experimental.Video;
using UnityEngine.Experimental.Audio;
using UnityEngine.Video;<br /><br />public class ManagedAudioOutput : <a href="MonoBehaviour.html">MonoBehaviour</a>
{
    <a href="Experimental.Audio.AudioSampleProvider.html">AudioSampleProvider</a> provider;<br /><br />    void Start()
    {
        <a href="Video.VideoPlayer.html">VideoPlayer</a> vp = GetComponent&lt;<a href="Video.VideoPlayer.html">VideoPlayer</a>&gt;();
        vp.audioOutputMode = <a href="Video.VideoAudioOutputMode.APIOnly.html">VideoAudioOutputMode.APIOnly</a>;
        vp.prepareCompleted += Prepared;
        vp.Prepare();
    }<br /><br />    void Prepared(<a href="Video.VideoPlayer.html">VideoPlayer</a> vp)
    {
        provider = vp.GetAudioSampleProvider(0);
        provider.sampleFramesAvailable += SampleFramesAvailable;
        provider.enableSampleFramesAvailableEvents = true;
        provider.freeSampleFrameCountLowThreshold = provider.maxSampleFrameCount / 4;
        vp.Play();
    }<br /><br />    void SampleFramesAvailable(<a href="Experimental.Audio.AudioSampleProvider.html">AudioSampleProvider</a> provider, uint sampleFrameCount)
    {
        using (NativeArray&lt;float&gt; buffer = new NativeArray&lt;float&gt;(
                       (int)sampleFrameCount * provider.channelCount, <a href="Unity.Collections.Allocator.Temp.html">Allocator.Temp</a>))
        {
            var sfCount = provider.ConsumeSampleFrames(buffer);
            <a href="Debug.LogFormat.html">Debug.LogFormat</a>("SetupSoftwareAudioOut.Available got {0} sample frames.", sfCount);
            // Do something with the samples here...
        }
    }
}
</pre>
      </div><div class="subsection"><p>The following is an example of how to access samples from C++. The setup has to be done in C# and then Unity's core and the native plug-in can call into each other without having to go through managed code.</p></div><div class="subsection">
        
        <pre class="codeExampleCS">
using System;
using System.Runtime.InteropServices;
using UnityEngine;
using UnityEngine.Experimental.Video;
using UnityEngine.Experimental.Audio;
using UnityEngine.Video;<br /><br />public class NativeAudioOutput : <a href="MonoBehaviour.html">MonoBehaviour</a>
{
    <a href="Experimental.Audio.AudioSampleProvider.html">AudioSampleProvider</a> provider;
    AudioSampleProvider.SampleFramesEventNativeFunction sampleFramesAvailableNativeHandler =
        SampleFramesAvailable;<br /><br />    void Start()
    {
        <a href="Video.VideoPlayer.html">VideoPlayer</a> vp = GetComponent&lt;<a href="Video.VideoPlayer.html">VideoPlayer</a>&gt;();
        vp.audioOutputMode = <a href="Video.VideoAudioOutputMode.APIOnly.html">VideoAudioOutputMode.APIOnly</a>;
        vp.prepareCompleted += Prepared;
        vp.Prepare();
    }<br /><br />    void Prepared(<a href="Video.VideoPlayer.html">VideoPlayer</a> vp)
    {
        provider = vp.GetAudioSampleProvider(0);
        provider.freeSampleFrameCountLowThreshold = provider.maxSampleFrameCount - 1024;<br /><br />        SetConsumeSampleFramesFunction(
            <a href="Experimental.Audio.AudioSampleProvider-consumeSampleFramesNativeFunction.html">AudioSampleProvider.consumeSampleFramesNativeFunction</a>, provider.id,
            provider.channelCount, provider.sampleRate);
        provider.SetSampleFramesAvailableNativeHandler(
            sampleFramesAvailableNativeHandler, (IntPtr)0);<br /><br />        vp.Play();
    }<br /><br />    private const string pluginName =
#if UNITY_IPHONE
        "__Internal"
#else
        "NativeAudioOutputPlugin"
#endif
    ;<br /><br />    [DllImport(pluginName, ExactSpelling = true, CallingConvention = CallingConvention.Cdecl)]
    private static extern void SetConsumeSampleFramesFunction(
        AudioSampleProvider.ConsumeSampleFramesNativeFunction cb, uint id, ushort channelCount, uint sampleRate);<br /><br />    [AOT.MonoPInvokeCallback(typeof(AudioSampleProvider.SampleFramesEventNativeFunction))]
    [DllImport(pluginName, ExactSpelling = true, CallingConvention = CallingConvention.Cdecl)]
    private static extern void SampleFramesAvailable(IntPtr userData, uint id, uint sampleFrameCount);
}
</pre>
      </div><div class="subsection"><p>And here is the accompanying C++ plug-in:</p></div><div class="subsection">
        
        <pre class="codeExampleCS">
#include &lt;algorithm&gt;
#include &lt;stdint.h&gt;<br /><br />typedef uint32_t(__cdecl *ConsumeSampleFramesFunction)(
    uint32_t providerId, float* interleavedSampleFrames, uint32_t sampleFrameCount);<br /><br />ConsumeSampleFramesFunction ConsumeSampleFrames = NULL;
uint32_t providerId = -1;
float* buffer = NULL;
uint32_t bufferSampleFrameCount = 0;
uint32_t availableSampleFrameCount = 0;<br /><br />extern "C" __cdecl void SetConsumeSampleFramesFunction(
    ConsumeSampleFramesFunction function, uint32_t id, uint16_t channelCount, uint32_t sampleRate)
{
    ConsumeSampleFrames = function;
    providerId = id;
    delete[] buffer;
    buffer = new float[channelCount * sampleRate]; // 1s worth of sample frames.
    bufferSampleFrameCount = sampleRate;
}<br /><br />extern "C" __cdecl void SampleFramesAvailable(void* userData, uint32_t id, uint32_t sampleFrameCount)
{
    if (ConsumeSampleFrames == NULL)
        return;<br /><br />    // We consume the sample frames from the handler that tells us that there are some available.
    // But we could also invoke this regularly from another thread, for example the thread providing
    // samples to an audio device.
    const uint32_t consumedSampleFrameCount = ConsumeSampleFrames(
            providerId, buffer, std::min(bufferSampleFrameCount, sampleFrameCount));
    // Do something with the samples here...
}
</pre>
      </div><div class="subsection"><h2>Static Properties</h2><table class="list">
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider-consumeSampleFramesNativeFunction.html">consumeSampleFramesNativeFunction</a></td><td class="desc"></td><td class="desc1">Pointer to the native function that provides access to audio sample frames.</td></tr>
    </table></div><div class="subsection"><h2>Properties   属性</h2><table class="list">
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider-availableSampleFrameCount.html">availableSampleFrameCount</a></td><td class="desc"></td><td class="desc1">Number of sample frames available for consuming with AudioSampleProvider.ConsumeSampleFrames.</td></tr>
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider-channelCount.html">channelCount</a></td><td class="desc"></td><td class="desc1">The number of audio channels per sample frame.</td></tr>
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider-enableSampleFramesAvailableEvents.html">enableSampleFramesAvailableEvents</a></td><td class="desc"></td><td class="desc1">Enables the AudioSampleProvider.sampleFramesAvailable events.</td></tr>
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider-enableSilencePadding.html">enableSilencePadding</a></td><td class="desc"></td><td class="desc1">If true, buffers produced by ConsumeSampleFrames will get padded when silence if there are less available than asked for. Otherwise, the extra sample frames in the buffer will be left unchanged.</td></tr>
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider-freeSampleFrameCount.html">freeSampleFrameCount</a></td><td class="desc"></td><td class="desc1">Number of sample frames that can still be written to by the sample producer before overflowing.</td></tr>
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider-freeSampleFrameCountLowThreshold.html">freeSampleFrameCountLowThreshold</a></td><td class="desc"></td><td class="desc1">Then the free sample count falls below this threshold, the AudioSampleProvider.sampleFramesAvailable event and associated native is emitted.</td></tr>
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider-id.html">id</a></td><td class="desc"></td><td class="desc1">Unique identifier for this instance.</td></tr>
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider-maxSampleFrameCount.html">maxSampleFrameCount</a></td><td class="desc"></td><td class="desc1">The maximum number of sample frames that can be accumulated inside the internal buffer before an overflow event is emitted.</td></tr>
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider-owner.html">owner</a></td><td class="desc"></td><td class="desc1">Object where this provider came from.</td></tr>
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider-sampleRate.html">sampleRate</a></td><td class="desc"></td><td class="desc1">The expected playback rate for the sample frames produced by this class.</td></tr>
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider-trackIndex.html">trackIndex</a></td><td class="desc"></td><td class="desc1">Index of the track in the object that created this provider.</td></tr>
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider-valid.html">valid</a></td><td class="desc"></td><td class="desc1">True if the object is valid.</td></tr>
    </table></div><div class="subsection"><h2>Public Methods   公共方法</h2><table class="list">
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider.ClearSampleFramesAvailableNativeHandler.html">ClearSampleFramesAvailableNativeHandler</a></td><td class="desc"></td><td class="desc1">Clear the native handler set with AudioSampleProvider.SetSampleFramesAvailableNativeHandler.</td></tr>
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider.ClearSampleFramesOverflowNativeHandler.html">ClearSampleFramesOverflowNativeHandler</a></td><td class="desc"></td><td class="desc1">Clear the native handler set with AudioSampleProvider.SetSampleFramesOverflowNativeHandler.</td></tr>
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider.ConsumeSampleFrames.html">ConsumeSampleFrames</a></td><td class="desc"></td><td class="desc1">Consume sample frames from the internal buffer.</td></tr>
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider.Dispose.html">Dispose</a></td><td class="desc"></td><td class="desc1">Release internal resources. Inherited from IDisposable.</td></tr>
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider.SetSampleFramesAvailableNativeHandler.html">SetSampleFramesAvailableNativeHandler</a></td><td class="desc"></td><td class="desc1">Set the native event handler for events emitted when the number of available sample frames crosses the threshold.</td></tr>
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider.SetSampleFramesOverflowNativeHandler.html">SetSampleFramesOverflowNativeHandler</a></td><td class="desc"></td><td class="desc1">Set the native event handler for events emitted when the internal sample frame buffer overflows.</td></tr>
    </table></div><div class="subsection"><h2>Events</h2><table class="list">
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider-sampleFramesAvailable.html">sampleFramesAvailable</a></td><td class="desc"></td><td class="desc1">Invoked when the number of available sample frames goes beyond the threshold set with AudioSampleProvider.freeSampleFrameCountLowThreshold.</td></tr>
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider-sampleFramesOverflow.html">sampleFramesOverflow</a></td><td class="desc"></td><td class="desc1">Invoked when the number of available sample frames goes beyond the maximum that fits in the internal buffer.</td></tr>
    </table></div><div class="subsection"><h2>Delegates</h2><table class="list">
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider.ConsumeSampleFramesNativeFunction.html">ConsumeSampleFramesNativeFunction</a></td><td class="desc"></td><td class="desc1">Type that represents the native function pointer for consuming sample frames.</td></tr>
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider.SampleFramesEventNativeFunction.html">SampleFramesEventNativeFunction</a></td><td class="desc"></td><td class="desc1">Type that represents the native function pointer for handling sample frame events.</td></tr>
      <tr><td class="descn"></td><td class="lbl"><a href="Experimental.Audio.AudioSampleProvider.SampleFramesHandler.html">SampleFramesHandler</a></td><td class="desc"></td><td class="desc1">Delegate for sample frame events.</td></tr>
    </table></div></div></div></div></body></html>